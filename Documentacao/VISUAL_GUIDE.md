# ?? Visual Guide das Melhorias

## ?? Diagrama de Arquitetura (Antes vs Depois)

### ANTES ?

```
???????????????????????????????????????????????????????
?                   HTTP REQUEST                       ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?              CONTROLLER                              ?
?  try {                                               ?
?    await _service.CreateAsync(...)                   ?
?  } catch (Exception ex) {                            ?
?    return Error500(ex)  ? Sem tratamento            ?
?  }                                                   ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?            APPLICATION SERVICE                       ?
?  try {                                               ?
?    await _createUseCase.Execute(...)                 ?
?  } catch (Exception) {                               ?
?    throw;  ? Repassa a exceção                      ?
?  }                                                   ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?              USE CASE                                ?
?  var user = new User(...);                           ?
?  await _repository.AddAsync(user);  ? SaveChanges!  ?
?  return user;  ? Sem Result Pattern                 ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?          REPOSITORY BASE                             ?
?  async Task AddAsync(User user) {                    ?
?    await DbSet.AddAsync(user);                       ?
?    await _context.SaveChangesAsync();  ? Aqui!      ?
?    return user;                                      ?
?  }                                                   ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?            DATABASE                                  ?
?  ? Sem transação centralizada                       ?
?  ? Sem rollback                                     ?
?  ? SaveChanges em vários lugares                    ?
???????????????????????????????????????????????????????
```

### DEPOIS ?

```
???????????????????????????????????????????????????????
?                   HTTP REQUEST                       ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?  GLOBAL EXCEPTION HANDLER MIDDLEWARE  ?             ?
?  try {                                               ?
?    await _next(context)                              ?
?  } catch (Exception ex) {                            ?
?    ? Mapeia tipo ? Status HTTP                      ?
?    ? Retorna JSON padronizado                       ?
?  }                                                   ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?              CONTROLLER                              ?
?  var result = await _service.CreateAsync(...)       ?
?  if (!result.IsSuccess)                              ?
?    return BadRequest(result.Error)  ? Tratado       ?
?  return Created(..., result.Value)                   ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?            APPLICATION SERVICE                       ?
?  var result = await _useCase.ExecuteAsync(...)       ?
?  if (!result.IsSuccess)  ? Result Pattern            ?
?    throw new InvalidOperationException(result.Error) ?
?  return _mapper.Map<UserDto>(result.Value)           ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?              USE CASE                                ?
?  try {                                               ?
?    ? Validações                                     ?
?    ? Specification Pattern                          ?
?    var user = new User(...);                         ?
?    await _repository.AddAsync(user);                 ?
?    await _unitOfWork.CommitAsync(); ? Aqui!         ?
?    return Result.Success(user);  ? Result           ?
?  } catch (Exception ex) {                            ?
?    await _unitOfWork.RollbackAsync(); ? Rollback    ?
?    return Result.Failure<User>(ex.Message);          ?
?  }                                                   ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?          REPOSITORY BASE                             ?
?  async Task AddAsync(User user) {                    ?
?    await DbSet.AddAsync(user);                       ?
?    return await Task.FromResult(user);               ?
?    ? NÃO chama SaveChanges                          ?
?  }                                                   ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?            UNIT OF WORK                              ?
?  async Task CommitAsync() {                          ?
?    return await _context.SaveChangesAsync();  ?     ?
?  }                                                   ?
?  async Task RollbackAsync() {                        ?
?    Detach all entries  ?                            ?
?  }                                                   ?
?????????????????????????????????????????????????????????
                 ?
                 ?
???????????????????????????????????????????????????????
?            DATABASE                                  ?
?  ? Transação centralizada                           ?
?  ? Rollback automático em caso de erro              ?
?  ? SaveChanges em um único lugar                    ?
???????????????????????????????????????????????????????
```

---

## ?? Fluxo de Dados - Result Pattern

```
USE CASE EXECUTION
       ?
       ?? Validar Entrada
       ?  ?? if (inválido) ? Result.Failure("erro")
       ?
       ?? Buscar Dados (Specification)
       ?  ?? if (não encontrado) ? Result.Failure("não encontrado")
       ?
       ?? Executar Lógica de Negócio
       ?  ?? if (violação de regra) ? Result.Failure("violação")
       ?
       ?? Persistir (Repository)
       ?  ?? await _repository.AddAsync(entity)
       ?
       ?? CONFIRMAR (Unit of Work) ?
       ?  ?? await _unitOfWork.CommitAsync()
       ?
       ?? Retornar Resultado
          ?? if (sucesso) ? Result.Success(entity)
          ?? if (erro) ? Result.Failure(mensagem)

         TRATAMENTO NO SERVICE
              ?
              ?
         if (!result.IsSuccess)
              ?
              ?? throw InvalidOperationException(result.Error)
              ?  ?? Capturado pelo Middleware
              ?
              ?? Enviado para Controller
                 ?? HTTP Response
```

---

## ??? Organização das Camadas

```
????????????????????????????????????????????????????????????
?                    API LAYER                              ?
????????????????????????????????????????????????????????????
?  ??????????????????????????????????????????????????????? ?
?  ?  Controllers                                        ? ?
?  ?  ?? Recebem HTTP requests                           ? ?
?  ?  ?? Chamam Services                                 ? ?
?  ?  ?? Retornam HTTP responses                         ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Middleware                                         ? ?
?  ?  ?? GlobalExceptionHandlerMiddleware ?             ? ?
?  ?  ?? Tratamento centralizado de exceções             ? ?
?  ??????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????
?               APPLICATION LAYER                           ?
????????????????????????????????????????????????????????????
?  ??????????????????????????????????????????????????????? ?
?  ?  Application Services                               ? ?
?  ?  ?? Orquestração de Use Cases                       ? ?
?  ?  ?? Mapeamento com AutoMapper                       ? ?
?  ?  ?? Trata Result Pattern                            ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Use Cases                                          ? ?
?  ?  ?? CreateUserUseCase ?                            ? ?
?  ?  ?? UpdateUserUseCase ?                            ? ?
?  ?  ?? DeleteUserUseCase ?                            ? ?
?  ?  ?? ChangePasswordUseCase ?                        ? ?
?  ?  ?? AddUserToDinnerUseCase ??                       ? ?
?  ?  ?? ...outros                                       ? ?
?  ?  ?? Implementam Unit of Work + Result               ? ?
?  ?  ?? Herdam de BaseUseCase (opcional)                ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  DTOs e Validators                                  ? ?
?  ?  ?? Validação de entrada                            ? ?
?  ?  ?? Mapeamento dados                                ? ?
?  ??????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????
?                 DOMAIN LAYER                              ?
????????????????????????????????????????????????????????????
?  ??????????????????????????????????????????????????????? ?
?  ?  Entities                                           ? ?
?  ?  ?? User, Event, Dinner, UserDinner, ...            ? ?
?  ?  ?? Herdam de EntityBase (auditoria)                ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Value Objects                                      ? ?
?  ?  ?? Email, Password, Cpf, PhoneNumber               ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Domain Services                                    ? ?
?  ?  ?? UserDomainService                               ? ?
?  ?  ?? UserDinnerDomainService                         ? ?
?  ?  ?? Lógica de negócio complexa                      ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Specifications                                     ? ?
?  ?  ?? UserByEmailSpecification ?                     ? ?
?  ?  ?? UserByCpfSpecification ?                       ? ?
?  ?  ?? ActiveUsersSpecification ?                     ? ?
?  ?  ?? Queries reutilizáveis                           ? ?
?  ?  ?? Centradas em Domain                             ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Interfaces (Contracts)                             ? ?
?  ?  ?? IRepository, IService, ISpecification            ? ?
?  ?  ?? Dependen inversão                               ? ?
?  ??????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????
?              INFRASTRUCTURE LAYER                         ?
????????????????????????????????????????????????????????????
?  ??????????????????????????????????????????????????????? ?
?  ?  Repositories                                       ? ?
?  ?  ?? BaseRepository<T> ?                            ? ?
?  ?  ?? UserRepository                                  ? ?
?  ?  ?? EventRepository                                 ? ?
?  ?  ?? Implementam IRepository                         ? ?
?  ?  ?? AddAsync, UpdateAsync, DeleteAsync, ...         ? ?
?  ?  ?? NÃO chamam SaveChanges                          ? ?
?  ?  ?? FindBySpecificationAsync ?                     ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Unit of Work                                       ? ?
?  ?  ?? CommitAsync() - salva todas as mudanças         ? ?
?  ?  ?? RollbackAsync() - reverte mudanças              ? ?
?  ?  ?? Controla transações                             ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Entity Framework Core Context                      ? ?
?  ?  ?? SNIContext                                      ? ?
?  ?  ?? DbSets: Users, Events, Dinners, ...             ? ?
?  ?  ?? Configurations (Mappings)                       ? ?
?  ??????????????????????????????????????????????????????? ?
?  ??????????????????????????????????????????????????????? ?
?  ?  Database                                           ? ?
?  ?  ?? SQL Server                                      ? ?
?  ?  ?? Migrations (EF Core)                            ? ?
?  ??????????????????????????????????????????????????????? ?
????????????????????????????????????????????????????????????
```

---

## ?? Ciclo de Vida de uma Requisição

```
1. HTTP POST /api/user
   ?? Recebida pelo Middleware
   ?? GlobalExceptionHandlerMiddleware.InvokeAsync()
   ?  ?? await _next(context)

2. Controller.Create([FromBody] UserCreateRequestDto request)
   ?? Valida DTO (FluentValidation)
   ?? Chama UserService.CreateAsync()

3. UserService.CreateAsync()
   ?? Monta CreateUserRequest
   ?? Chama CreateUserUseCase.ExecuteAsync()
   ?? Trata Result<User>
   ?? if (!result.IsSuccess) ? throw InvalidOperationException

4. CreateUserUseCase.ExecuteAsync()
   ?? Validações iniciais
   ?? Specification: UserByEmailSpecification
   ?? try {
   ?  ?? new User(...) ? Entidade de domínio
   ?  ?? await _userRepository.AddAsync(user)
   ?  ?? await _unitOfWork.CommitAsync() ? COMMIT
   ?  ?? return Result.Success(user)
   ? } catch (Exception ex) {
   ?  ?? await _unitOfWork.RollbackAsync() ? ROLLBACK
   ?  ?? return Result.Failure<User>(ex.Message)
   ? }

5. UserRepository.AddAsync()
   ?? await DbSet.AddAsync(user)
   ?? NÃO salva (removido)
   ?? return user

6. UnitOfWork.CommitAsync()
   ?? await _context.SaveChangesAsync() ? AQUI!
   ?? Transação confirmada

7. Volta ao Service
   ?? Map User ? UserDto
   ?? return UserDto

8. Volta ao Controller
   ?? return CreatedAtAction(...)
   ?? HTTP 201 Created

9. Response (JSON)
   {
     "id": 1,
     "name": "João",
     "email": "joao@test.com",
     ...
   }
```

---

## ?? Mapeamento de Responsabilidades

```
????????????????????????????????????????????????????????????
? Responsável ? Tarefa                                     ?
????????????????????????????????????????????????????????????
? Controller  ? Receber HTTP, validar DTO, chamar service  ?
? Service     ? Coordenar use cases, mapear dados         ?
? Use Case    ? Lógica de aplicação, coordenação          ?
? Domain      ? Regras de negócio, validações            ?
? Repository  ? Abstração de dados (sem SaveChanges)      ?
? UnitOfWork  ? Transações, Commit/Rollback              ?
? Middleware  ? Exceções globais, logging                ?
? Database    ? Persistência                              ?
????????????????????????????????????????????????????????????
```

---

## ? Checklist de Implementação

- [x] Unit of Work pattern implementado
- [x] Result Pattern aplicado
- [x] Specification Pattern expandido
- [x] Global Exception Handler criado
- [x] Base Use Case criado
- [x] 4 Use Cases de escrita migrados
- [x] Documentação completa
- [x] Build sem erros
- [ ] Testes unitários
- [ ] Deploy em produção

---

**Criado:** 2025-01-XX  
**Versão:** 1.0  
**Status:** ? Pronto para uso
